#!/usr/bin/env ruby

require_relative '../lib/rapicco'

def print_usage
  puts "Usage: rapicco [command] [options] <slide.md>"
  puts ""
  puts "Commands:"
  puts "  rapicco new <directory>                      Create slide project template"
  puts "  rapicco new .                                Create template in current directory"
  puts "  rapicco <slide.md>                           Run presentation"
  puts "  rapicco --print <slide.md>                   Export to PDF (slide.pdf)"
  puts "  rapicco -p -o output.pdf <slide.md>          Export to PDF with custom name"
  puts ""
  puts "Options:"
  puts "  -p, --print                  Export presentation to PDF instead of running"
  puts "  -o, --output-filename FILE   Output PDF filename (default: <slide>.pdf)"
  puts "  --rapicco-command CMD        Command to run Rapicco (default: use PICORUBY_PATH)"
  puts "  -h, --help                   Show this help message"
  puts ""
  puts "PDF export options:"
  puts "  --cols NUMBER                Terminal columns for PDF capture (default: 500)"
  puts "  --rows NUMBER                Terminal rows for PDF capture (default: 280)"
  puts "  --char-width NUMBER          Character width in pixels (default: 5)"
  puts "  --char-height NUMBER         Character height in pixels (default: 10)"
  puts ""
  puts "Examples:"
  puts "  rapicco new my-slide"
  puts "  rapicco new ."
  puts "  rapicco presentation.md"
  puts "  rapicco --print presentation.md"
  puts "  rapicco -p -o output.pdf presentation.md"
  puts "  rapicco -p --cols 600 --rows 150 presentation.md"
end

# Check for new command
if ARGV[0] == 'new'
  if ARGV.length != 2
    puts "Error: Please provide a directory name"
    puts "Usage: rapicco new <directory>"
    exit 1
  end

  require_relative '../lib/rapicco/installer'
  installer = Rapicco::Installer.new(ARGV[1])
  begin
    installer.install
    exit 0
  rescue => e
    puts "Error: #{e.message}"
    exit 1
  end
end

options = {}
args = []

print_mode = false

i = 0
while i < ARGV.length
  case ARGV[i]
  when '-h', '--help'
    print_usage
    exit 0
  when '-p', '--print'
    print_mode = true
  when '-o', '--output-filename'
    options[:output_filename] = ARGV[i + 1]
    i += 1
  when '--rapicco-command'
    options[:rapicco_command] = ARGV[i + 1]
    i += 1
  when '--cols'
    options[:cols] = ARGV[i + 1].to_i
    i += 1
  when '--rows'
    # Rapicco uses half-block characters (2 vertical dots per character)
    # so divide rows by 2 for internal processing
    options[:rows] = ARGV[i + 1].to_i / 2
    i += 1
  when '--char-width'
    options[:char_width] = ARGV[i + 1].to_i
    i += 1
  when '--char-height'
    options[:char_height] = ARGV[i + 1].to_i
    i += 1
  else
    args << ARGV[i]
  end
  i += 1
end

if args.length != 1
  puts "Error: Please provide a slide file"
  puts ""
  print_usage
  exit 1
end

slide_file = args[0]

unless File.exist?(slide_file)
  puts "Error: Input file not found: #{slide_file}"
  exit 1
end

if print_mode
  # PDF export mode
  output_pdf = options[:output_filename] || slide_file.sub(/\.[^.]+$/, '.pdf')

  # Auto-calculate missing dimension for 16:9 aspect ratio
  if options[:cols] && !options[:rows]
    # cols specified, calculate rows for 16:9
    # Divide by 2 because Rapicco uses half-block characters (2 vertical dots per character)
    options[:rows] = (options[:cols] * 9.0 / 16.0 / 2.0).round
  elsif !options[:cols] && options[:rows]
    # rows specified (already divided by 2), calculate cols for 16:9
    # Multiply by 2 to get actual vertical dots before calculating horizontal
    options[:cols] = (options[:rows] * 2.0 * 16.0 / 9.0).round
  end

  begin
    converter = Rapicco::PDF::Converter.new(slide_file, output_pdf, options)
    converter.convert
  rescue => e
    puts "Error: #{e.message}"
    puts e.backtrace if ENV['DEBUG']
    exit 1
  end
else
  # Presentation mode
  begin
    presenter = Rapicco::Presenter.new(slide_file, options)
    presenter.run
  rescue => e
    puts "Error: #{e.message}"
    puts e.backtrace if ENV['DEBUG']
    exit 1
  end
end
